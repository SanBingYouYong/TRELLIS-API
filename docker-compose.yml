services:
  trellis-api:
    build: .
    ports:
      - "8000:8000"
    volumes:
      - ./cache:/root/.cache
      # - ./generated:/app/generated  # For persistent storage of generated files
    environment:
      - CUDA_VISIBLE_DEVICES=0
      - SPCONV_ALGO=native
      - TORCH_CUDA_ARCH_LIST=10.0 10.1 12.0
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    command: python text_to_3d_api.py --host 0.0.0.0 --port 8000
    
  # Optional: nginx reverse proxy for production
  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - trellis-api
    profiles:
      - production
